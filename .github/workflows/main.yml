name: Rydoo Security & Functional CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *' # Automated nightly regression at midnight

# Essential for GitHub Pages deployment and OIDC security
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test-and-report:
    name: Execute Tests & Deploy Allure Report
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Build Docker Image
        run: docker build -t rydoo-automation .

      - name: ğŸ§ª Run Cypress Tests in Isolated Container
        run: |
          # Passing CI metadata to Docker for dynamic Allure Environment info
          docker run --name rydoo-container \
            -e GITHUB_ACTIONS=true \
            -e GITHUB_ACTOR=${{ github.actor }} \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e QA_USER=${{ secrets.QA_USER }} \
            -e QA_PASS=${{ secrets.QA_PASS }} \
            -e PROD_USER=${{ secrets.PROD_USER }} \
            -e PROD_PASS=${{ secrets.PROD_PASS }} \
            rydoo-automation
        continue-on-error: true # Crucial: Generate report even if tests fail

      - name: ğŸ“¥ Extract Allure Results from Container
        run: docker cp rydoo-container:/app/allure-results ./allure-results

      - name: ğŸ“Š Setup Allure Report Environment
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report

      - name: ğŸš€ Deploy Live Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          force_orphan: true # Keeps the gh-pages branch clean